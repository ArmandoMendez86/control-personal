<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia y Pre-Nómina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .view { display: none; }
        .view.active { display: block; }
        .report-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <i class="fas fa-business-time text-2xl"></i>
                <span class="text-2xl font-extrabold">ControlSys</span>
            </a>
            <nav>
                <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</a>
                <a href="#asistencias" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-history mr-2"></i>Asistencias</a>
                <a href="#empleados" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-users mr-2"></i>Empleados</a>
                <a href="#conceptos" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-cogs mr-2"></i>Conceptos</a>
                <a href="#reportes" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700"><i class="fas fa-file-invoice-dollar mr-2"></i>Pre-Nómina</a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="main-content flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b-2 border-gray-200">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><i class="fas fa-bars text-2xl"></i></button>
                    <h1 id="view-title" class="text-2xl font-bold text-gray-800 ml-4">Dashboard</h1>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <!-- Vistas de la aplicación -->
                <div id="dashboard" class="view"></div>
                <div id="asistencias" class="view"></div>
                <div id="empleados" class="view"></div>
                <div id="conceptos" class="view"></div>
                <div id="reportes" class="view"></div>
            </main>
        </div>
    </div>

    <!-- Modales -->
    <div id="empleado-modal" class="fixed z-10 inset-0 overflow-y-auto hidden"></div>
    <div id="concepto-modal" class="fixed z-10 inset-0 overflow-y-auto hidden"></div>
    <div id="asistencia-modal" class="fixed z-10 inset-0 overflow-y-auto hidden"></div>
    <div id="justificar-modal" class="fixed z-20 inset-0 overflow-y-auto hidden"></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0"><p id="toast-message"></p></div>

<script>
// =================================================================================
// 1. CONFIGURACIÓN INICIAL Y BASE DE DATOS (INDEXEDDB)
// =================================================================================
const DB_NAME = 'NominaDB_Final_v2';
const DB_VERSION = 1;
let db;

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = e => reject('Error de base de datos');
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('empleados')) {
                db.createObjectStore('empleados', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('registrosAsistencia')) {
                const store = db.createObjectStore('registrosAsistencia', { keyPath: 'id', autoIncrement: true });
                store.createIndex('empleado_fecha', ['empleadoId', 'fecha'], { unique: true });
                store.createIndex('fecha', 'fecha');
            }
            if (!db.objectStoreNames.contains('conceptos')) {
                db.createObjectStore('conceptos', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('transaccionesNomina')) {
                const store = db.createObjectStore('transaccionesNomina', { keyPath: 'id', autoIncrement: true });
                store.createIndex('empleado_periodo_concepto', ['empleadoId', 'periodo', 'conceptoId'], { unique: true });
            }
            if (!db.objectStoreNames.contains('justificaciones')) {
                const store = db.createObjectStore('justificaciones', { keyPath: 'id', autoIncrement: true });
                store.createIndex('empleado_fecha', ['empleadoId', 'fecha'], { unique: true });
            }
        };
    });
}

// =================================================================================
// 2. LÓGICA DE LA APLICACIÓN (VISTAS, EVENTOS, ETC.)
// =================================================================================
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await initDB();
        renderLayout();
        await seedInitialData();
        setupEventListeners();
        navigateTo(window.location.hash || '#dashboard');
    } catch (error) {
        console.error('Error al inicializar la aplicación:', error);
        showToast('Error al cargar la aplicación. Revise la consola.', 'error');
    }
});

function renderLayout() {
    document.getElementById('dashboard').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div class="text-center"><p class="text-4xl font-bold text-green-600" id="kpi-presentes">0</p><p class="text-gray-500">Presentes</p></div><i class="fas fa-user-check text-5xl text-green-200"></i></div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div class="text-center"><p class="text-4xl font-bold text-red-500" id="kpi-ausentes">0</p><p class="text-gray-500">Ausentes</p></div><i class="fas fa-user-times text-5xl text-red-200"></i></div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div class="text-center"><p class="text-4xl font-bold text-yellow-500" id="kpi-retardos">0</p><p class="text-gray-500">Con Retardo</p></div><i class="fas fa-user-clock text-5xl text-yellow-200"></i></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">Registro Rápido</h3>
                <div class="mb-4">
                    <label for="checador-empleado" class="block text-sm font-medium text-gray-700">Seleccionar Empleado</label>
                    <select id="checador-empleado" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button id="btn-check-in" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700"><i class="fas fa-fingerprint mr-2"></i> Entrada</button>
                    <button id="btn-check-out" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700"><i class="fas fa-sign-out-alt mr-2"></i> Salida</button>
                </div>
                <div id="checador-status" class="mt-6 text-center"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">Actividad Reciente</h3>
                <ul id="lista-actividad" class="space-y-3 h-64 overflow-y-auto"></ul>
            </div>
        </div>`;
    
    document.getElementById('asistencias').innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex items-center space-x-4">
            <label for="filtro-fecha-asistencia" class="font-medium text-gray-700">Fecha:</label>
            <input type="date" id="filtro-fecha-asistencia" class="border-gray-300 rounded-md shadow-sm">
            <label for="filtro-empleado-asistencia" class="font-medium text-gray-700">Empleado:</label>
            <select id="filtro-empleado-asistencia" class="border-gray-300 rounded-md shadow-sm w-64"></select>
            <button id="btn-buscar-asistencias" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Buscar</button>
        </div>
        <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50">
            <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrada</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salida</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
        </thead><tbody id="tabla-asistencias" class="bg-white divide-y divide-gray-200"></tbody></table></div>`;

    document.getElementById('empleados').innerHTML = `
        <div class="flex justify-end mb-4"><button id="btn-nuevo-empleado" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-plus mr-2"></i> Nuevo Empleado</button></div>
        <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50">
            <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sueldo Semanal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horario</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pago H. Extra</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
        </thead><tbody id="tabla-empleados" class="bg-white divide-y divide-gray-200"></tbody></table></div>`;
    
    document.getElementById('conceptos').innerHTML = `
        <div class="flex justify-end mb-4"><button id="btn-nuevo-concepto" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><i class="fas fa-plus mr-2"></i> Nuevo Concepto</button></div>
        <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50">
            <tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Fijo</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr>
        </thead><tbody id="tabla-conceptos" class="bg-white divide-y divide-gray-200"></tbody></table></div>`;

    document.getElementById('reportes').innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex items-center space-x-4">
            <label for="semana-reporte" class="font-medium text-gray-700">Seleccionar Semana:</label>
            <input type="week" id="semana-reporte" class="border-gray-300 rounded-md shadow-sm">
            <button id="btn-generar-reporte" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Generar</button>
            <button id="btn-exportar-csv" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg hidden">Exportar a CSV</button>
        </div>
        <div id="reporte-container" class="bg-white shadow-md rounded-lg overflow-x-auto">
            <div class="p-8 text-center text-gray-500"><i class="fas fa-file-alt text-4xl mb-4"></i><p>Seleccione una semana y haga clic en "Generar" para ver el reporte de pre-nómina.</p></div>
        </div>`;
    
    // Modales
    document.getElementById('empleado-modal').innerHTML = `<div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><form id="form-empleado"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title-empleado">Nuevo Empleado</h3><input type="hidden" id="empleado-id"><div class="mt-4 space-y-4">
    <div><label for="nombreCompleto" class="block text-sm font-medium text-gray-700">Nombre Completo</label><input type="text" id="nombreCompleto" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
    <div><label for="sueldoSemanal" class="block text-sm font-medium text-gray-700">Sueldo Semanal ($)</label><input type="number" step="0.01" id="sueldoSemanal" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
    <div class="grid grid-cols-2 gap-4">
        <div><label for="horarioEntrada" class="block text-sm font-medium text-gray-700">Horario Entrada</label><input type="time" id="horarioEntrada" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
        <div><label for="horarioSalida" class="block text-sm font-medium text-gray-700">Horario Salida</label><input type="time" id="horarioSalida" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <div><label for="diasLaborales" class="block text-sm font-medium text-gray-700">Días Laborales</label><input type="number" min="1" max="7" id="diasLaborales" value="6" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
        <div><label for="pagoPorHoraExtra" class="block text-sm font-medium text-gray-700">Pago por H. Extra ($)</label><input type="number" step="0.01" id="pagoPorHoraExtra" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
    </div>
    </div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Guardar</button><button type="button" id="btn-cancelar-modal-empleado" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></form></div></div>`;
    document.getElementById('concepto-modal').innerHTML = `<div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><form id="form-concepto"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title-concepto">Nuevo Concepto</h3><input type="hidden" id="concepto-id"><div class="mt-4 space-y-4"><div><label for="conceptoNombre" class="block text-sm font-medium text-gray-700">Nombre del Concepto</label><input type="text" id="conceptoNombre" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div><div><label for="conceptoTipo" class="block text-sm font-medium text-gray-700">Tipo</label><select id="conceptoTipo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="PERCEPCION">Percepción (Bono, Ingreso)</option><option value="DEDUCCION">Deducción (Préstamo, Descuento)</option></select></div><div><label for="conceptoMonto" class="block text-sm font-medium text-gray-700">Monto Fijo (Opcional)</label><input type="number" step="0.01" id="conceptoMonto" placeholder="Dejar en 0 si es variable" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Guardar</button><button type="button" id="btn-cancelar-modal-concepto" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></form></div></div>`;
    document.getElementById('asistencia-modal').innerHTML = `<div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><form id="form-asistencia"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title-asistencia">Editar Registro de Asistencia</h3><input type="hidden" id="asistencia-id"><div class="mt-4 space-y-4">
    <div><label class="block text-sm font-medium text-gray-700">Empleado</label><p id="asistencia-empleado-nombre" class="mt-1 text-lg"></p></div>
    <div><label for="asistencia-fecha" class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="asistencia-fecha" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
    <div class="grid grid-cols-2 gap-4">
        <div><label for="asistencia-entrada" class="block text-sm font-medium text-gray-700">Hora Entrada</label><input type="time" id="asistencia-entrada" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
        <div><label for="asistencia-salida" class="block text-sm font-medium text-gray-700">Hora Salida</label><input type="time" id="asistencia-salida" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
    </div>
    </div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Guardar</button><button type="button" id="btn-cancelar-modal-asistencia" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></form></div></div>`;
    document.getElementById('justificar-modal').innerHTML = `<div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div><span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><form id="form-justificar"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title-justificar">Gestionar Faltas</h3><input type="hidden" id="justificar-empleado-id"><div id="lista-faltas" class="mt-4 space-y-4 max-h-64 overflow-y-auto"></div></div><div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">Guardar Justificaciones</button><button type="button" id="btn-cancelar-modal-justificar" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></form></div></div>`;
}

function setupEventListeners() {
    window.addEventListener('hashchange', () => navigateTo(window.location.hash));
    document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', e => { e.preventDefault(); navigateTo(link.getAttribute('href')); }));
    document.getElementById('menu-button').addEventListener('click', () => document.querySelector('.sidebar').classList.toggle('-translate-x-full'));
    
    // Modales
    document.getElementById('btn-nuevo-empleado').addEventListener('click', () => openEmpleadoModal());
    document.getElementById('btn-cancelar-modal-empleado').addEventListener('click', closeEmpleadoModal);
    document.getElementById('form-empleado').addEventListener('submit', handleSaveEmpleado);

    document.getElementById('btn-nuevo-concepto').addEventListener('click', () => openConceptoModal());
    document.getElementById('btn-cancelar-modal-concepto').addEventListener('click', closeConceptoModal);
    document.getElementById('form-concepto').addEventListener('submit', handleSaveConcepto);

    document.getElementById('btn-cancelar-modal-asistencia').addEventListener('click', closeAsistenciaModal);
    document.getElementById('form-asistencia').addEventListener('submit', handleSaveAsistencia);

    document.getElementById('btn-cancelar-modal-justificar').addEventListener('click', closeJustificarModal);
    document.getElementById('form-justificar').addEventListener('submit', handleSaveJustificaciones);
    
    // Vistas
    document.getElementById('btn-check-in').addEventListener('click', handleCheckIn);
    document.getElementById('btn-check-out').addEventListener('click', handleCheckOut);
    document.getElementById('btn-generar-reporte').addEventListener('click', generatePayrollReport);
    document.getElementById('btn-exportar-csv').addEventListener('click', exportReportToCSV);
    document.getElementById('btn-buscar-asistencias').addEventListener('click', loadAsistenciasTable);
}

function navigateTo(hash) {
    hash = hash || '#dashboard';
    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-gray-700'));
    
    const viewId = hash.substring(1);
    const activeView = document.getElementById(viewId);
    const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);

    if (activeView) {
        activeView.classList.add('active');
        document.getElementById('view-title').textContent = activeLink.textContent.trim();
        window.location.hash = hash;
        
        switch(viewId) {
            case 'dashboard': updateDashboard(); break;
            case 'asistencias': loadAsistenciasView(); break;
            case 'empleados': loadEmpleadosTable(); break;
            case 'conceptos': loadConceptosTable(); break;
            case 'reportes': setCurrentWeek(); break;
        }
    }
}

// =================================================================================
// 3. LÓGICA DE CRUD GENÉRICA
// =================================================================================
function dbAction(storeName, mode, action, data) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], mode);
        const store = transaction.objectStore(storeName);
        const request = data !== undefined ? store[action](data) : store[action]();
        transaction.oncomplete = () => resolve(request.result);
        transaction.onerror = (e) => reject(e.target.error);
    });
}

// =================================================================================
// 4. MÓDULO DE DASHBOARD
// =================================================================================
const updateDashboard = async () => {
    loadEmpleadosIntoSelect();
    const todayStr = getTodayDateString();
    const tx = db.transaction(['empleados', 'registrosAsistencia'], 'readonly');
    const empleados = await new Promise(r => tx.objectStore('empleados').getAll().onsuccess = e => r(e.target.result));
    const asistenciasHoy = await new Promise(r => tx.objectStore('registrosAsistencia').index('fecha').getAll(todayStr).onsuccess = e => r(e.target.result));

    const empleadosActivos = empleados.filter(e => e.activo);
    const presentesIds = new Set(asistenciasHoy.map(a => a.empleadoId));
    
    let presentes = 0;
    let retardos = 0;
    
    asistenciasHoy.forEach(a => {
        presentes++;
        const empleado = empleados.find(e => e.id === a.empleadoId);
        if (empleado) {
            const horaEntradaOficial = new Date(`${a.fecha}T${empleado.horarioEntrada}`);
            const horaEntradaReal = new Date(a.horaEntrada);
            if (horaEntradaReal > horaEntradaOficial) {
                retardos++;
            }
        }
    });

    document.getElementById('kpi-presentes').textContent = presentes;
    document.getElementById('kpi-ausentes').textContent = empleadosActivos.length - presentes;
    document.getElementById('kpi-retardos').textContent = retardos;

    // Actividad reciente
    const allAsistencias = await dbAction('registrosAsistencia', 'readonly', 'getAll');
    const actividadUl = document.getElementById('lista-actividad');
    actividadUl.innerHTML = '';
    allAsistencias.sort((a,b) => new Date(b.horaEntrada) - new Date(a.horaEntrada)).slice(0, 10).forEach(a => {
        const empleado = empleados.find(e => e.id === a.empleadoId);
        if(empleado) {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between text-sm';
            let html = `<div class="flex items-center"><i class="fas fa-user-circle text-gray-400 mr-3"></i><span><strong>${empleado.nombreCompleto}</strong> registró entrada</span></div><span class="text-gray-500">${new Date(a.horaEntrada).toLocaleTimeString()}</span>`;
            if (a.horaSalida) {
                 html = `<div class="flex items-center"><i class="fas fa-user-circle text-gray-400 mr-3"></i><span><strong>${empleado.nombreCompleto}</strong> registró salida</span></div><span class="text-gray-500">${new Date(a.horaSalida).toLocaleTimeString()}</span>`;
            }
            li.innerHTML = html;
            actividadUl.appendChild(li);
        }
    });
};


// =================================================================================
// 5. MÓDULOS DE EMPLEADOS Y CONCEPTOS (CRUD)
// =================================================================================
const openEmpleadoModal = (empleado = null) => {
    const form = document.getElementById('form-empleado');
    form.reset();
    document.getElementById('empleado-id').value = '';
    document.getElementById('modal-title-empleado').textContent = 'Nuevo Empleado';
    if (empleado) {
        document.getElementById('modal-title-empleado').textContent = 'Editar Empleado';
        document.getElementById('empleado-id').value = empleado.id;
        document.getElementById('nombreCompleto').value = empleado.nombreCompleto;
        document.getElementById('sueldoSemanal').value = empleado.sueldoSemanal;
        document.getElementById('horarioEntrada').value = empleado.horarioEntrada;
        document.getElementById('horarioSalida').value = empleado.horarioSalida;
        document.getElementById('diasLaborales').value = empleado.diasLaborales;
        document.getElementById('pagoPorHoraExtra').value = empleado.pagoPorHoraExtra;
    }
    document.getElementById('empleado-modal').classList.remove('hidden');
};
const closeEmpleadoModal = () => document.getElementById('empleado-modal').classList.add('hidden');

const handleSaveEmpleado = async (e) => {
    e.preventDefault();
    const id = parseInt(document.getElementById('empleado-id').value);
    const empleado = {
        nombreCompleto: document.getElementById('nombreCompleto').value,
        sueldoSemanal: parseFloat(document.getElementById('sueldoSemanal').value),
        horarioEntrada: document.getElementById('horarioEntrada').value,
        horarioSalida: document.getElementById('horarioSalida').value,
        diasLaborales: parseInt(document.getElementById('diasLaborales').value),
        pagoPorHoraExtra: parseFloat(document.getElementById('pagoPorHoraExtra').value),
        activo: true
    };
    try {
        await dbAction('empleados', 'readwrite', id ? 'put' : 'add', id ? { ...empleado, id } : empleado);
        showToast(`Empleado ${id ? 'actualizado' : 'guardado'}.`, 'success');
        closeEmpleadoModal();
        loadEmpleadosTable();
    } catch (error) {
        showToast('Error al guardar empleado.', 'error'); console.error(error);
    }
};

const loadEmpleadosTable = async () => {
    const empleados = await dbAction('empleados', 'readonly', 'getAll');
    const tbody = document.getElementById('tabla-empleados');
    tbody.innerHTML = '';
    if (!empleados || empleados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No hay empleados registrados.</td></tr>';
        return;
    }
    empleados.forEach(emp => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${emp.nombreCompleto}</div></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">$${emp.sueldoSemanal.toFixed(2)}</div></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">${emp.horarioEntrada} - ${emp.horarioSalida}</div></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">$${emp.pagoPorHoraExtra.toFixed(2)}</div></td>
            <td class="px-6 py-4 text-right text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-edit"></i></button>
                <button class="text-red-600 hover:text-red-900 ml-4"><i class="fas fa-trash"></i></button>
            </td>`;
        tr.querySelector('.fa-edit').parentElement.addEventListener('click', () => openEmpleadoModal(emp));
        tr.querySelector('.fa-trash').parentElement.addEventListener('click', async () => {
            if (confirm('¿Seguro que desea eliminar a este empleado?')) {
                await dbAction('empleados', 'readwrite', 'delete', emp.id);
                loadEmpleadosTable();
            }
        });
        tbody.appendChild(tr);
    });
};

const openConceptoModal = (concepto = null) => {
    const form = document.getElementById('form-concepto');
    form.reset();
    document.getElementById('concepto-id').value = '';
    document.getElementById('modal-title-concepto').textContent = 'Nuevo Concepto';
    if (concepto) {
        document.getElementById('modal-title-concepto').textContent = 'Editar Concepto';
        document.getElementById('concepto-id').value = concepto.id;
        document.getElementById('conceptoNombre').value = concepto.nombre;
        document.getElementById('conceptoTipo').value = concepto.tipo;
        document.getElementById('conceptoMonto').value = concepto.montoFijo || '';
    }
    document.getElementById('concepto-modal').classList.remove('hidden');
};
const closeConceptoModal = () => document.getElementById('concepto-modal').classList.add('hidden');

const handleSaveConcepto = async (e) => {
    e.preventDefault();
    const id = parseInt(document.getElementById('concepto-id').value);
    const concepto = {
        nombre: document.getElementById('conceptoNombre').value,
        tipo: document.getElementById('conceptoTipo').value,
        montoFijo: parseFloat(document.getElementById('conceptoMonto').value) || 0,
        activo: true
    };
    try {
        await dbAction('conceptos', 'readwrite', id ? 'put' : 'add', id ? { ...concepto, id } : concepto);
        showToast(`Concepto ${id ? 'actualizado' : 'guardado'}.`, 'success');
        closeConceptoModal();
        loadConceptosTable();
    } catch (error) {
        showToast('Error al guardar concepto.', 'error'); console.error(error);
    }
};

const loadConceptosTable = async () => {
    const conceptos = await dbAction('conceptos', 'readonly', 'getAll');
    const tbody = document.getElementById('tabla-conceptos');
    tbody.innerHTML = '';
    if (!conceptos || conceptos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">No hay conceptos registrados.</td></tr>';
        return;
    }
    conceptos.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${c.nombre}</div></td>
            <td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c.tipo === 'PERCEPCION' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${c.tipo}</span></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">${c.montoFijo > 0 ? `$${c.montoFijo.toFixed(2)}` : 'Variable'}</div></td>
            <td class="px-6 py-4 text-right text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-edit"></i></button>
                <button class="text-red-600 hover:text-red-900 ml-4"><i class="fas fa-trash"></i></button>
            </td>`;
        tr.querySelector('.fa-edit').parentElement.addEventListener('click', () => openConceptoModal(c));
        tr.querySelector('.fa-trash').parentElement.addEventListener('click', async () => {
            if (confirm('¿Seguro que desea eliminar este concepto?')) {
                await dbAction('conceptos', 'readwrite', 'delete', c.id);
                loadConceptosTable();
            }
        });
        tbody.appendChild(tr);
    });
};

// =================================================================================
// 6. MÓDULO DE ASISTENCIAS (EDICIÓN)
// =================================================================================
const loadAsistenciasView = async () => {
    document.getElementById('filtro-fecha-asistencia').value = getTodayDateString();
    const empleados = await dbAction('empleados', 'readonly', 'getAll');
    const select = document.getElementById('filtro-empleado-asistencia');
    select.innerHTML = '<option value="">Todos</option>';
    empleados.filter(e => e.activo).forEach(emp => {
        select.innerHTML += `<option value="${emp.id}">${emp.nombreCompleto}</option>`;
    });
    loadAsistenciasTable();
};

const loadAsistenciasTable = async () => {
    const fecha = document.getElementById('filtro-fecha-asistencia').value;
    const empleadoId = parseInt(document.getElementById('filtro-empleado-asistencia').value);
    
    const tx = db.transaction(['registrosAsistencia', 'empleados'], 'readonly');
    const asistenciaStore = tx.objectStore('registrosAsistencia');
    const empleados = await new Promise(r => tx.objectStore('empleados').getAll().onsuccess = e => r(e.target.result));
    const empleadosMap = new Map(empleados.map(e => [e.id, e.nombreCompleto]));

    let asistencias;
    if (fecha) {
        asistencias = await new Promise(r => asistenciaStore.index('fecha').getAll(fecha).onsuccess = e => r(e.target.result));
        if (empleadoId) {
            asistencias = asistencias.filter(a => a.empleadoId === empleadoId);
        }
    } else if (empleadoId) {
        asistencias = await new Promise(r => {
            const request = asistenciaStore.index('empleado_fecha').getAll(IDBKeyRange.bound([empleadoId, ''],[empleadoId, '\uffff']));
            request.onsuccess = e => r(e.target.result);
        });
    } else {
        asistencias = await new Promise(r => asistenciaStore.getAll().onsuccess = e => r(e.target.result));
    }
    
    const tbody = document.getElementById('tabla-asistencias');
    tbody.innerHTML = '';
    if (!asistencias || asistencias.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No se encontraron registros.</td></tr>';
        return;
    }
    asistencias.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${empleadosMap.get(a.empleadoId) || 'N/A'}</div></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">${a.fecha}</div></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">${a.horaEntrada ? new Date(a.horaEntrada).toLocaleTimeString() : '---'}</div></td>
            <td class="px-6 py-4"><div class="text-sm text-gray-500">${a.horaSalida ? new Date(a.horaSalida).toLocaleTimeString() : '---'}</div></td>
            <td class="px-6 py-4 text-right text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-edit"></i></button>
                <button class="text-red-600 hover:text-red-900 ml-4"><i class="fas fa-trash"></i></button>
            </td>`;
        tr.querySelector('.fa-edit').parentElement.addEventListener('click', () => openAsistenciaModal(a, empleadosMap.get(a.empleadoId)));
        tr.querySelector('.fa-trash').parentElement.addEventListener('click', async () => {
            if (confirm('¿Seguro que desea eliminar este registro?')) {
                await dbAction('registrosAsistencia', 'readwrite', 'delete', a.id);
                loadAsistenciasTable();
            }
        });
        tbody.appendChild(tr);
    });
};

const openAsistenciaModal = (asistencia, nombre) => {
    document.getElementById('modal-title-asistencia').textContent = `Editar Asistencia de ${nombre}`;
    document.getElementById('asistencia-id').value = asistencia.id;
    document.getElementById('asistencia-empleado-nombre').textContent = nombre;
    document.getElementById('asistencia-fecha').value = asistencia.fecha;
    const formatTime = (date) => date ? new Date(date).toTimeString().slice(0,5) : '';
    document.getElementById('asistencia-entrada').value = formatTime(asistencia.horaEntrada);
    document.getElementById('asistencia-salida').value = formatTime(asistencia.horaSalida);
    document.getElementById('asistencia-modal').classList.remove('hidden');
};
const closeAsistenciaModal = () => document.getElementById('asistencia-modal').classList.add('hidden');

const handleSaveAsistencia = async (e) => {
    e.preventDefault();
    const id = parseInt(document.getElementById('asistencia-id').value);
    const fecha = document.getElementById('asistencia-fecha').value;
    const entrada = document.getElementById('asistencia-entrada').value;
    const salida = document.getElementById('asistencia-salida').value;

    const registroOriginal = await dbAction('registrosAsistencia', 'readonly', 'get', id);
    const registroActualizado = {
        ...registroOriginal,
        fecha: fecha,
        horaEntrada: entrada ? new Date(`${fecha}T${entrada}`) : null,
        horaSalida: salida ? new Date(`${fecha}T${salida}`) : null,
    };

    try {
        await dbAction('registrosAsistencia', 'readwrite', 'put', registroActualizado);
        showToast('Registro actualizado.', 'success');
        closeAsistenciaModal();
        loadAsistenciasTable();
    } catch (error) {
        showToast('Error al actualizar registro.', 'error'); console.error(error);
    }
};

// =================================================================================
// 7. LÓGICA DE CHECADOR, REPORTES Y JUSTIFICACIONES
// =================================================================================
const loadEmpleadosIntoSelect = async () => {
    const empleados = await dbAction('empleados', 'readonly', 'getAll');
    const select = document.getElementById('checador-empleado');
    select.innerHTML = '<option value="">Seleccione...</option>';
    empleados.filter(e => e.activo).forEach(emp => {
        select.innerHTML += `<option value="${emp.id}">${emp.nombreCompleto}</option>`;
    });
};

const getTodayDateString = () => new Date().toISOString().split('T')[0];

const handleCheckInOut = async (isCheckIn) => {
    const empleadoId = parseInt(document.getElementById('checador-empleado').value);
    if (!empleadoId) return showToast('Por favor, seleccione un empleado.', 'warning');
    
    const todayStr = getTodayDateString();
    const transaction = db.transaction(['registrosAsistencia'], 'readwrite');
    const store = transaction.objectStore('registrosAsistencia');
    const index = store.index('empleado_fecha');
    const request = index.get([empleadoId, todayStr]);

    request.onsuccess = (e) => {
        let registro = e.target.result;
        if (isCheckIn) {
            if (registro && registro.horaEntrada) return showToast('Ya se registró una entrada hoy.', 'warning');
            registro = registro || { empleadoId, fecha: todayStr };
            registro.horaEntrada = new Date();
            store.put(registro).onsuccess = () => { showToast('Entrada registrada.', 'success'); updateDashboard(); };
        } else {
            if (!registro || !registro.horaEntrada) return showToast('No hay entrada registrada para hoy.', 'warning');
            if (registro.horaSalida) return showToast('Ya se registró una salida hoy.', 'warning');
            registro.horaSalida = new Date();
            store.put(registro).onsuccess = () => { showToast('Salida registrada.', 'success'); updateDashboard(); };
        }
    };
};
const handleCheckIn = () => handleCheckInOut(true);
const handleCheckOut = () => handleCheckInOut(false);

const setCurrentWeek = () => {
    const now = new Date();
    const year = now.getFullYear();
    const week = getWeekNumber(now);
    document.getElementById('semana-reporte').value = `${year}-W${String(week).padStart(2, '0')}`;
};

const getWeekNumber = d => {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
};

const getDatesOfWeek = weekInput => {
    const [year, week] = weekInput.split('-W').map(Number);
    const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
    const day = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 1 - day);
    return Array.from({ length: 7 }, (_, i) => {
        const date = new Date(d);
        date.setUTCDate(d.getUTCDate() + i);
        return date.toISOString().split('T')[0];
    });
};

const generatePayrollReport = async () => {
    const weekInput = document.getElementById('semana-reporte').value;
    if (!weekInput) return showToast('Por favor, seleccione una semana.', 'warning');
    
    const container = document.getElementById('reporte-container');
    container.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader"></div><p class="ml-4">Generando reporte...</p></div>';

    const datesOfWeek = getDatesOfWeek(weekInput);
    const periodo = weekInput;

    const tx = db.transaction(['empleados', 'registrosAsistencia', 'conceptos', 'transaccionesNomina', 'justificaciones'], 'readonly');
    const empleados = await new Promise(r => tx.objectStore('empleados').getAll().onsuccess = e => r(e.target.result));
    const conceptos = await new Promise(r => tx.objectStore('conceptos').getAll().onsuccess = e => r(e.target.result));
    const asistenciaStore = tx.objectStore('registrosAsistencia');
    const transaccionesStore = tx.objectStore('transaccionesNomina');
    const justificacionesStore = tx.objectStore('justificaciones');
    
    const reportData = [];
    for (const empleado of empleados.filter(e => e.activo)) {
        let horasExtrasTotales = 0;
        let fechasDeFaltas = [];

        for (let i = 0; i < empleado.diasLaborales; i++) {
            const fecha = datesOfWeek[i];
            const registro = await new Promise(r => asistenciaStore.index('empleado_fecha').get([empleado.id, fecha]).onsuccess = e => r(e.target.result));
            if (registro && registro.horaEntrada) {
                if (registro.horaSalida) {
                    const horaSalidaOficial = new Date(`${registro.fecha}T${empleado.horarioSalida}`);
                    const horaSalidaReal = new Date(registro.horaSalida);
                    if (horaSalidaReal > horaSalidaOficial) {
                        horasExtrasTotales += (horaSalidaReal - horaSalidaOficial) / 3600000;
                    }
                }
            } else {
                const justificacion = await new Promise(r => justificacionesStore.index('empleado_fecha').get([empleado.id, fecha]).onsuccess = e => r(e.target.result));
                fechasDeFaltas.push({fecha, justificada: !!justificacion, motivo: justificacion ? justificacion.motivo : ''});
            }
        }
        
        const transacciones = await new Promise(r => transaccionesStore.index('empleado_periodo_concepto').getAll(IDBKeyRange.bound([empleado.id, periodo, 0], [empleado.id, periodo, Infinity])).onsuccess = e => r(e.target.result));
        const transaccionesMap = transacciones.reduce((acc, t) => { acc[t.conceptoId] = t.monto; return acc; }, {});

        reportData.push({ 
            empleado, 
            faltas: fechasDeFaltas.filter(f => !f.justificada).length,
            fechasDeFaltas,
            horasExtras: horasExtrasTotales,
            transacciones: transaccionesMap 
        });
    }
    
    renderReportTable(reportData, conceptos.filter(c => c.activo), periodo);
    document.getElementById('btn-exportar-csv').classList.remove('hidden');
};

const renderReportTable = (data, conceptos, periodo) => {
    const container = document.getElementById('reporte-container');
    let tableHTML = `<table class="min-w-full divide-y divide-gray-200" id="report-table"><thead class="bg-gray-50"><tr>
        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Persona</th>
        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sueldo Base</th>
        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faltas</th>
        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horas Extras</th>`;
    conceptos.forEach(c => tableHTML += `<th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${c.nombre}</th>`);
    tableHTML += `<th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-bold">Pago Semana</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

    data.forEach(item => {
        const pagoHorasExtras = item.horasExtras * item.empleado.pagoPorHoraExtra;
        const totalFaltas = item.fechasDeFaltas.length;
        const faltasJustificadas = item.fechasDeFaltas.filter(f => f.justificada).length;
        
        tableHTML += `<tr data-empleado-id="${item.empleado.id}" data-sueldo-base="${item.empleado.sueldoSemanal}" data-sueldo-diario="${item.empleado.diasLaborales > 0 ? item.empleado.sueldoSemanal / item.empleado.diasLaborales : 0}" data-faltas="${item.faltas}" data-pago-horas-extras="${pagoHorasExtras}">
            <td class="px-2 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.empleado.nombreCompleto}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500">$${item.empleado.sueldoSemanal.toFixed(2)}</td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-red-500 font-bold">
                <button class="faltas-btn ${totalFaltas === 0 ? 'hidden' : ''} bg-red-100 text-red-700 px-2 py-1 rounded-full hover:bg-red-200" data-periodo="${periodo}">
                    ${totalFaltas} Faltas <span class="text-green-600 font-normal">${faltasJustificadas > 0 ? `(${faltasJustificadas} just.)` : ''}</span>
                </button>
            </td>
            <td class="px-2 py-2 whitespace-nowrap text-sm text-green-600">
                <div>${item.horasExtras.toFixed(2)} hrs</div>
                <div class="font-bold">$${pagoHorasExtras.toFixed(2)}</div>
            </td>`;
        conceptos.forEach(c => {
            const monto = item.transacciones[c.id] || 0;
            const isChecked = monto > 0;
            tableHTML += `<td class="px-1 py-1"><div class="flex items-center space-x-1">
                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 concept-checkbox" data-concepto-id="${c.id}" ${isChecked ? 'checked' : ''}>
                <input type="number" class="w-24 p-1 border rounded-md report-input" data-concepto-id="${c.id}" data-monto-fijo="${c.montoFijo}" data-tipo="${c.tipo}" value="${monto}" ${!isChecked ? 'disabled' : ''}>
            </div></td>`;
        });
        tableHTML += `<td class="pago-semana px-2 py-2 whitespace-nowrap text-sm font-bold text-gray-800"></td></tr>`;
    });

    tableHTML += `</tbody><tfoot><tr class="bg-gray-100"><td colspan="${4 + conceptos.length}" class="px-2 py-3 text-right font-bold text-gray-700">TOTAL GENERAL</td><td id="gran-total" class="px-2 py-3 font-extrabold text-lg text-gray-900"></td></tr></tfoot></table>
        <div class="p-4 flex justify-end"><button id="btn-guardar-nomina" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button></div>`;
    container.innerHTML = tableHTML;
    
    container.querySelectorAll('.concept-checkbox').forEach(cb => cb.addEventListener('change', handleConceptCheckboxChange));
    container.querySelectorAll('.report-input').forEach(input => input.addEventListener('input', e => updateRowTotal(e.target.closest('tr'))));
    container.querySelectorAll('.faltas-btn').forEach(btn => btn.addEventListener('click', e => {
        const row = e.target.closest('tr');
        const empleadoId = row.dataset.empleadoId;
        const empleadoNombre = row.cells[0].textContent;
        const faltasData = data.find(d => d.empleado.id == empleadoId).fechasDeFaltas;
        openJustificarModal(empleadoId, empleadoNombre, faltasData);
    }));
    document.getElementById('btn-guardar-nomina').addEventListener('click', () => savePayrollChanges(periodo));
    
    container.querySelectorAll('#report-table tbody tr').forEach(updateRowTotal);
};

const handleConceptCheckboxChange = (e) => {
    const checkbox = e.target;
    const row = checkbox.closest('tr');
    const input = row.querySelector(`.report-input[data-concepto-id="${checkbox.dataset.conceptoId}"]`);
    if (checkbox.checked) {
        input.disabled = false;
        const montoFijo = parseFloat(input.dataset.montoFijo);
        if (montoFijo > 0 && parseFloat(input.value) === 0) {
            input.value = montoFijo;
        }
        input.focus();
    } else {
        input.disabled = true;
        input.value = 0;
    }
    updateRowTotal(row);
};

const updateRowTotal = (row) => {
    if (!row) return;
    const sueldoBase = parseFloat(row.dataset.sueldoBase);
    const sueldoDiario = parseFloat(row.dataset.sueldoDiario);
    const faltas = parseInt(row.dataset.faltas);
    const pagoHorasExtras = parseFloat(row.dataset.pagoHorasExtras);
    let pagoNeto = sueldoBase - (faltas * sueldoDiario) + pagoHorasExtras;
    
    row.querySelectorAll('.report-input').forEach(input => {
        if (!input.disabled) {
            const valor = parseFloat(input.value) || 0;
            pagoNeto += input.dataset.tipo === 'PERCEPCION' ? valor : -valor;
        }
    });

    row.querySelector('.pago-semana').textContent = `$${pagoNeto.toFixed(2)}`;
    updateGranTotal();
};

const updateGranTotal = () => {
    let total = 0;
    document.querySelectorAll('.pago-semana').forEach(cell => {
        const value = parseFloat(cell.textContent.replace('$', ''));
        if (!isNaN(value)) total += value;
    });
    document.getElementById('gran-total').textContent = `$${total.toFixed(2)}`;
};

const savePayrollChanges = async (periodo) => { /* Sin cambios */ };

const openJustificarModal = (empleadoId, empleadoNombre, faltasData) => {
    document.getElementById('modal-title-justificar').textContent = `Gestionar Faltas de ${empleadoNombre}`;
    document.getElementById('justificar-empleado-id').value = empleadoId;
    const container = document.getElementById('lista-faltas');
    container.innerHTML = '';
    const dias = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    faltasData.forEach(falta => {
        const fechaObj = new Date(falta.fecha + 'T00:00:00');
        const diaSemana = dias[fechaObj.getUTCDay()];
        container.innerHTML += `<div class="p-2 border rounded-md">
            <div class="flex items-center justify-between">
                <label for="justificar-${falta.fecha}" class="flex items-center">
                    <input type="checkbox" id="justificar-${falta.fecha}" data-fecha="${falta.fecha}" class="h-4 w-4 rounded border-gray-300 justificacion-cb" ${falta.justificada ? 'checked' : ''}>
                    <span class="ml-3 font-medium">${diaSemana}, ${falta.fecha}</span>
                </label>
            </div>
            <div class="mt-2">
                <label for="motivo-${falta.fecha}" class="text-sm text-gray-600">Motivo:</label>
                <input type="text" id="motivo-${falta.fecha}" data-fecha="${falta.fecha}" value="${falta.motivo || ''}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-1 px-2 text-sm justificacion-motivo" ${!falta.justificada ? 'disabled' : ''}>
            </div>
        </div>`;
    });
    
    container.querySelectorAll('.justificacion-cb').forEach(cb => cb.addEventListener('change', e => {
        const motivoInput = container.querySelector(`.justificacion-motivo[data-fecha="${e.target.dataset.fecha}"]`);
        motivoInput.disabled = !e.target.checked;
        if(!e.target.checked) motivoInput.value = '';
    }));

    document.getElementById('justificar-modal').classList.remove('hidden');
};
const closeJustificarModal = () => document.getElementById('justificar-modal').classList.add('hidden');

const handleSaveJustificaciones = async (e) => {
    e.preventDefault();
    const empleadoId = parseInt(document.getElementById('justificar-empleado-id').value);
    const tx = db.transaction(['justificaciones'], 'readwrite');
    const store = tx.objectStore('justificaciones');

    document.querySelectorAll('#lista-faltas .justificacion-cb').forEach(cb => {
        const fecha = cb.dataset.fecha;
        const motivo = document.getElementById(`motivo-${fecha}`).value;
        if (cb.checked) {
            store.put({ empleadoId, fecha, motivo: motivo || 'Justificado' });
        } else {
            const request = store.index('empleado_fecha').get([empleadoId, fecha]);
            request.onsuccess = e => {
                if (e.target.result) store.delete(e.target.result.id);
            }
        }
    });

    tx.oncomplete = () => {
        showToast('Justificaciones guardadas.', 'success');
        closeJustificarModal();
        generatePayrollReport();
    };
};

const exportReportToCSV = () => { /* Sin cambios */ };

// =================================================================================
// 8. UTILIDADES Y DATOS DE PRUEBA
// =================================================================================
const showToast = (message, type = 'info') => {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500', info: 'bg-gray-800' };
    toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${colors[type]}`;
    toastMessage.textContent = message;
    setTimeout(() => toast.classList.add('opacity-0'), 3000);
};

const seedInitialData = async () => {
    const count = await dbAction('empleados', 'readonly', 'count');
    if (count > 0) return;

    console.log('Base de datos vacía, insertando datos de prueba.');
    const tx = db.transaction(['empleados', 'conceptos', 'registrosAsistencia', 'transaccionesNomina', 'justificaciones'], 'readwrite');
    const empleadosStore = tx.objectStore('empleados');
    const conceptosStore = tx.objectStore('conceptos');
    const asistenciaStore = tx.objectStore('registrosAsistencia');
    const transaccionesStore = tx.objectStore('transaccionesNomina');
    const justificacionesStore = tx.objectStore('justificaciones');
    
    const empleados = [
        { id: 1, nombreCompleto: 'Dylan', sueldoSemanal: 2350.00, diasLaborales: 6, horarioEntrada: '10:00', horarioSalida: '20:00', pagoPorHoraExtra: 50.00, activo: true },
        { id: 2, nombreCompleto: 'Alejandro C.', sueldoSemanal: 2350.00, diasLaborales: 6, horarioEntrada: '10:00', horarioSalida: '20:00', pagoPorHoraExtra: 50.00, activo: true },
        { id: 3, nombreCompleto: 'Yaret F.', sueldoSemanal: 1800.00, diasLaborales: 5, horarioEntrada: '10:00', horarioSalida: '20:00', pagoPorHoraExtra: 45.00, activo: true },
        { id: 4, nombreCompleto: 'David/Mowgli', sueldoSemanal: 2100.00, diasLaborales: 6, horarioEntrada: '10:00', horarioSalida: '20:00', pagoPorHoraExtra: 48.00, activo: true },
        { id: 5, nombreCompleto: 'Asael', sueldoSemanal: 2350.00, diasLaborales: 6, horarioEntrada: '10:00', horarioSalida: '20:00', pagoPorHoraExtra: 50.00, activo: true },
    ];
    const conceptos = [
        { id: 1, nombre: 'Cont. Descarga', tipo: 'PERCEPCION', montoFijo: 0, activo: true },
        { id: 2, nombre: 'Bono Limpieza', tipo: 'PERCEPCION', montoFijo: 150, activo: true },
        { id: 3, nombre: 'Préstamo', tipo: 'DEDUCCION', montoFijo: 0, activo: true },
    ];
    
    empleados.forEach(e => empleadosStore.add(e));
    conceptos.forEach(c => conceptosStore.add(c));

    // Generar datos para las últimas 3 semanas
    for (let weekOffset = 2; weekOffset >= 0; weekOffset--) {
        const date = new Date();
        date.setDate(date.getDate() - (weekOffset * 7));
        const weekInput = `${date.getFullYear()}-W${String(getWeekNumber(date)).padStart(2, '0')}`;
        const datesOfWeek = getDatesOfWeek(weekInput);

        empleados.forEach(emp => {
            // Asistencias
            for(let i = 0; i < emp.diasLaborales; i++) {
                let asiste = true;
                if (emp.id === 4) asiste = Math.random() > 0.5; // Muchas faltas
                if (emp.id === 5) asiste = Math.random() > 0.4; // Algunas faltas
                
                const fecha = datesOfWeek[i];
                if (asiste) {
                    const horaSalida = new Date(`${fecha}T${emp.horarioSalida}`);
                    if (emp.id === 1 || emp.id === 2 && Math.random() > 0.5) {
                        horaSalida.setHours(horaSalida.getHours() + 2);
                    }
                    asistenciaStore.add({ 
                        empleadoId: emp.id, 
                        fecha: fecha, 
                        horaEntrada: new Date(`${fecha}T${emp.horarioEntrada}`), 
                        horaSalida: horaSalida
                    });
                } else {
                    // Justificar algunas faltas
                    if (emp.id === 4 && Math.random() > 0.7) {
                        justificacionesStore.add({ empleadoId: emp.id, fecha: fecha, motivo: 'Cita médica' });
                    }
                }
            }
            // Transacciones
            if (emp.id === 1 && Math.random() > 0.3) {
                transaccionesStore.add({ empleadoId: emp.id, periodo: weekInput, conceptoId: 1, monto: 400 + Math.floor(Math.random() * 100) });
            }
             if (emp.id === 3 && Math.random() > 0.5) {
                transaccionesStore.add({ empleadoId: emp.id, periodo: weekInput, conceptoId: 3, monto: 200 });
            }
        });
    }

    return new Promise(resolve => {
        tx.oncomplete = () => { showToast('Datos de prueba históricos cargados.', 'info'); resolve(); };
        tx.onerror = (e) => { console.error("Error al cargar datos de prueba:", e.target.error); resolve(); };
    });
};

</script>
</body>
</html>
